#!/usr/bin/env bash

SYNTH_SAMPLE_RATE=44100
SYNTH_AMPLITUDE=28000  # Max 32767, leave headroom

# Sine lookup table: sin(0..359 degrees) * 10000
# Generated with: for i in range(360): print(int(sin(radians(i)) * 10000))
declare -a SIN_TABLE=(
    0 175 349 523 698 872 1045 1219 1392 1564
    1736 1908 2079 2250 2419 2588 2756 2924 3090 3256
    3420 3584 3746 3907 4067 4226 4384 4540 4695 4848
    5000 5150 5299 5446 5592 5736 5878 6018 6157 6293
    6428 6561 6691 6820 6947 7071 7193 7314 7431 7547
    7660 7771 7880 7986 8090 8192 8290 8387 8480 8572
    8660 8746 8829 8910 8988 9063 9135 9205 9272 9336
    9397 9455 9511 9563 9613 9659 9703 9744 9781 9816
    9848 9877 9903 9925 9945 9962 9976 9986 9994 9998
    10000 9998 9994 9986 9976 9962 9945 9925 9903 9877
    9848 9816 9781 9744 9703 9659 9613 9563 9511 9455
    9397 9336 9272 9205 9135 9063 8988 8910 8829 8746
    8660 8572 8480 8387 8290 8192 8090 7986 7880 7771
    7660 7547 7431 7314 7193 7071 6947 6820 6691 6561
    6428 6293 6157 6018 5878 5736 5592 5446 5299 5150
    5000 4848 4695 4540 4384 4226 4067 3907 3746 3584
    3420 3256 3090 2924 2756 2588 2419 2250 2079 1908
    1736 1564 1392 1219 1045 872 698 523 349 175
    0 -175 -349 -523 -698 -872 -1045 -1219 -1392 -1564
    -1736 -1908 -2079 -2250 -2419 -2588 -2756 -2924 -3090 -3256
    -3420 -3584 -3746 -3907 -4067 -4226 -4384 -4540 -4695 -4848
    -5000 -5150 -5299 -5446 -5592 -5736 -5878 -6018 -6157 -6293
    -6428 -6561 -6691 -6820 -6947 -7071 -7193 -7314 -7431 -7547
    -7660 -7771 -7880 -7986 -8090 -8192 -8290 -8387 -8480 -8572
    -8660 -8746 -8829 -8910 -8988 -9063 -9135 -9205 -9272 -9336
    -9397 -9455 -9511 -9563 -9613 -9659 -9703 -9744 -9781 -9816
    -9848 -9877 -9903 -9925 -9945 -9962 -9976 -9986 -9994 -9998
    -10000 -9998 -9994 -9986 -9976 -9962 -9945 -9925 -9903 -9877
    -9848 -9816 -9781 -9744 -9703 -9659 -9613 -9563 -9511 -9455
    -9397 -9336 -9272 -9205 -9135 -9063 -8988 -8910 -8829 -8746
    -8660 -8572 -8480 -8387 -8290 -8192 -8090 -7986 -7880 -7771
    -7660 -7547 -7431 -7314 -7193 -7071 -6947 -6820 -6691 -6561
    -6428 -6293 -6157 -6018 -5878 -5736 -5592 -5446 -5299 -5150
    -5000 -4848 -4695 -4540 -4384 -4226 -4067 -3907 -3746 -3584
    -3420 -3256 -3090 -2924 -2756 -2588 -2419 -2250 -2079 -1908
    -1736 -1564 -1392 -1219 -1045 -872 -698 -523 -349 -175
)

_write_sample() {
    local value="$1"
    # Convert signed 16-bit to unsigned for byte extraction
    if [[ $value -lt 0 ]]; then
        value=$(( value + 65536 ))
    fi
    local lo=$(( value & 0xFF ))
    local hi=$(( (value >> 8) & 0xFF ))
    printf "\\x$(printf '%02x' $lo)\\x$(printf '%02x' $hi)"
}

synth_sine() {
    local frequency="$1"
    local duration_ms="$2"

    local num_samples=$(( SYNTH_SAMPLE_RATE * duration_ms / 1000 ))

    # Phase increment per sample (scaled by 10000 for precision)
    # phase_increment = frequency * 360 / sample_rate
    # We scale by 10000 to maintain precision
    local phase_inc=$(( frequency * 360 * 10000 / SYNTH_SAMPLE_RATE ))
    local phase=0

    for ((i=0; i<num_samples; i++)); do
        # Get degree from phase (scaled by 10000)
        local degree=$(( (phase / 10000) % 360 ))
        if [[ $degree -lt 0 ]]; then
            degree=$(( degree + 360 ))
        fi

        # Get sin value from table and scale to amplitude
        local sin_val="${SIN_TABLE[$degree]}"
        local sample=$(( sin_val * SYNTH_AMPLITUDE / 10000 ))

        _write_sample "$sample"

        phase=$(( phase + phase_inc ))
    done
}
